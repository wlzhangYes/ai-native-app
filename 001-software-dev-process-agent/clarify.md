# 需求澄清文档（Clarification）

**项目**: 软件产品开发流程智能体
**Feature Branch**: `001-software-dev-process-agent`
**创建日期**: 2025-10-23
**状态**: 待澄清

---

## 📌 澄清说明

本文档用于记录在spec.md基础上需要进一步澄清的问题。

**重要原则**：
- ✅ spec.md中的用户故事、需求、验收标准保持不变
- ✅ 本文档只记录疑问和答案
- ✅ 澄清完成后，如需补充需求，在spec.md末尾追加，不修改原有内容
- ✅ 所有澄清问题按类别组织

---

## 一、工作流程相关

### Q1.1: 阶段跳转规则 ✅

**问题**:
- 用户是否可以跳过某个阶段直接进入下一阶段？
- 如果用户想回到上一个已完成的阶段修改，是否需要重新执行后续阶段？
- 是否支持同时进行多个阶段（例如同时修改宪章和spec）？

**答案**:
1. **不可以跳过阶段** - 必须按照阶段0→1→2→3→4的顺序执行，每个阶段完成后才能进入下一阶段
2. **不需要重新执行后续阶段** - 用户可以回到已完成的阶段修改内容，修改保存后，后续已完成的阶段保持不变，不需要重新执行
3. **不支持并行** - 用户在任意时刻只能在一个阶段工作，不能同时编辑多个阶段的内容

**影响范围**:
- FR-025（流程顺序执行规则）
- 工作流引擎的核心逻辑设计

---

### Q1.2: AI引导的具体内容 ✅

**问题**:
- 每个阶段AI教练会问哪些具体问题？
- 问题是固定的还是根据用户回答动态生成的？
- 如果用户回答不完整或跳过某些问题，AI如何处理？

**答案**:
1. **智能生成问题** - AI根据用户选择的宪章模板动态生成问题，不同的宪章模板会引导不同的问题
2. **按宪章引导提问** - AI根据宪章中定义的原则、规则和要求来设计问题，确保生成的spec、plan等文档符合该宪章的要求
3. **不完整回答处理** - AI主动引导用户，基于上下文给出推理和猜测：
   - 当用户回答不完整时，AI分析已有信息，推测可能的答案
   - AI提出2-3个推测选项供用户选择或确认
   - AI说明每个推测的理由和影响
   - 用户可以选择AI的推测、修改推测或提供自己的答案
   - 如果用户仍然跳过，AI在文档中标注 [AI推测: ...] 并在后续澄清

**影响范围**:
- AI对话流程设计
- 产品体验和实施复杂度

---

### Q1.3: 文档生成时机 ✅

**问题**:
- constitution.md是在用户回答完问题后立即生成，还是用户确认后才生成？
- spec.md是一次性生成完整文档，还是随着用户回答逐步生成？
- 文档生成失败后，用户之前输入的内容是否保留？

**答案**:
1. **边回答边生成** - 所有文档（constitution.md、spec.md等）都随着用户回答逐步生成，实时更新
2. **立即生成** - 用户每回答一个问题，AI立即生成或更新对应的文档片段，无需等待用户确认
3. **保留输入内容** - 如果文档生成失败，用户之前输入的所有内容必须保留在数据库中，不能丢失

**影响范围**:
- FR-027（文档生成）
- 数据持久化策略

---

## 二、界面交互相关

### Q2.1: 对话内容的图标 ✅

**问题**:
- "箭头"、"白点"、"绿点"、"红点"、"闪烁星号"的具体视觉样式是什么？
- 这些图标是在消息前面、后面还是作为消息的背景？
- 是否有其他状态需要区分（如警告、待确认等）？

**答案**:
1. **图标位置** - 在消息内容的前面显示
2. **具体视觉样式** - 交给设计师发挥，保持简洁易识别的原则
3. **其他状态** - 目前定义的5种状态（箭头、白点、绿点、红点、闪烁星号）已足够，暂不需要其他状态

**影响范围**:
- FR-013（对话内容区分显示）
- UI/UX设计规范

---

### Q2.2: 文档对比视图 ✅

**问题**:
- 左右对比视图是全屏显示还是在右侧面板中显示？
- 对比视图如何高亮显示差异部分？
- 如果修改很多，对比视图如何展示（分页、滚动、折叠）？

**答案**:
1. **显示位置** - 在右侧的「结果预览」页签中显示对比视图（不是全屏）
2. **差异高亮** -
   - 红色字体：显示修改前的旧内容
   - 绿色字体：显示修改后的新内容
3. **大量修改展示** - 使用滚动方式，用户可以上下滚动查看所有差异内容

**影响范围**:
- FR-016（左右对比视图）
- 文档diff算法选择

---

### Q2.3: 流程树和数据树的交互 ✅

**问题**:
- 流程树和数据树是否可以折叠/展开？
- 点击流程树的某个阶段，数据树是否自动定位到对应文档？
- 数据树中的文档是否有状态标识（草稿、完成、待审核等）？

**答案**:
1. **支持折叠/展开** - 流程树和数据树都可以折叠/展开，方便用户管理视图空间
2. **自动定位** - 点击流程树的某个阶段时，数据树自动定位并展开到对应的文档
3. **文档状态标识** - 数据树中的文档有两种状态：
   - 草稿（Draft）：文档正在编辑中，尚未完成
   - 完成（Completed）：文档已完成并确认

**影响范围**:
- FR-010（中间区域两列展示）
- FR-032（活动定位上下文）

---

## 三、数据同步相关

### Q3.1: 飞书文档同步机制 ⚠️ 高优先级 ✅

**问题**:
- 本地数据库和飞书文档的同步是实时的还是批量的？
- 如果用户在飞书文档中直接编辑，修改是否会同步回本地数据库？
- 同步冲突如何解决（本地优先还是飞书优先）？

**答案**:
1. **实时同步** - 本地数据库的文档内容变更时，立即实时同步到飞书文档
2. **单向同步** - 用户在飞书文档中的直接编辑不会同步回本地数据库，飞书仅作为只读展示和归档用途
3. **本地优先** - 如果发生同步冲突（如并发更新），以本地数据库的内容为准，覆盖飞书文档

**影响范围**:
- FR-028（文档同步到飞书）
- 数据一致性架构设计

---

### Q3.2: AMDP数据同步 ✅

**问题**:
- AMDP目录数据的同步频率是多少（每小时、每天）？
- 如果用户正在创建项目时AMDP数据更新，如何处理？
- 缓存数据的有效期是多久？

**答案**:
1. **使用AMDP同步接口** - 通过AMDP提供的同步接口获取目录数据
2. **同步频率** - 每天凌晨定时同步一次（组织架构数据通常变化不频繁）
3. **创建项目时数据更新** - 如果用户正在创建项目时AMDP数据更新，不影响当前操作，用户继续使用当前缓存的数据完成项目创建
4. **缓存有效期** - 24小时，与同步频率一致。超过有效期后，如果定时任务失败，系统仍可使用过期缓存但显示警告

**影响范围**:
- FR-037（从AMDP获取目录数据）
- 缓存策略设计

---

## 四、权限和协作相关

### Q4.1: 权限变更生效时机 ⚠️ 高优先级 ✅

**问题**:
- 权限修改后是否立即生效？
- 如果用户A正在编辑文档，此时被移除编辑权限，如何处理？
- 用户是否能查看自己被移除权限的历史记录？

**答案**:
1. **立即生效** - 权限修改后立即生效，不需要用户重新登录或刷新页面
2. **阻止下一次操作** - 如果用户A正在编辑文档，被移除编辑权限后：
   - 当前正在进行的操作可能还能完成
   - 下一次尝试任何编辑操作时，系统检测到权限变更，阻止操作并提示"您的权限已被修改"
3. **暂不支持历史记录** - 第一版不支持查看权限变更历史记录功能

**影响范围**:
- FR-045~051（权限管理）
- 安全和用户体验设计

---

### Q4.2: 多人协作策略 ⚠️ 高优先级 ✅

**问题**:
- 是否支持多人同时编辑同一文档？
- 如果不支持，是否有锁定机制（谁在编辑时其他人只读）？
- 是否显示"某某正在编辑"的提示？

**答案**:
1. **不支持多人同时编辑** - 同一文档在同一时刻只能由一个用户编辑
2. **编辑权限** - 目前只有具有编辑权限的角色（所有者和编辑者）可以编辑文档
3. **无锁定机制** - 第一版暂不实现文档锁定和"某某正在编辑"的实时提示功能
4. **冲突处理** - 如果多人尝试同时编辑，后提交的修改会覆盖先提交的修改（简单的最后写入胜利策略）

**影响范围**:
- 并发控制设计
- WebSocket实时通信需求

---

## 五、异步任务相关

### Q5.1: 任务执行策略 ✅

**问题**:
- 异步任务的超时时间是多少？
- 如果任务执行时间超过预期（例如超过5分钟），如何处理？
- 用户是否可以主动取消正在执行的任务？

**答案**:
1. **无超时限制** - 异步任务没有超时时间限制，任务会一直执行直到完成或失败
2. **AI长链接支持** - 后端通过AI长链接机制保持任务持续执行，不会因为执行时间长而中断
3. **支持主动取消** - 用户可以主动取消正在执行的任务，取消后任务停止执行

**影响范围**:
- FR-039~040（异步任务执行）
- 任务队列设计

---

### Q5.2: 飞书通知时机 ✅

**问题**:
- 飞书通知是任务完成立即发送，还是有延迟？
- 如果用户同时有多个任务完成，是发送多条消息还是合并成一条？
- 用户点击飞书卡片按钮后，是否会跳转回智能体页面？

**答案**:
1. **短暂延迟** - 任务完成后有短暂延迟再发送飞书通知（如5-10秒），避免频繁发送通知
2. **合并通知** - 如果用户在短时间内有多个任务完成，合并成一条消息发送，列出所有完成的任务
3. **无需跳转** - 用户点击飞书卡片按钮后，系统后台执行相应操作，不需要跳转回智能体页面

**影响范围**:
- FR-041~044（飞书通知）
- 通知系统设计

---

## 六、业务规则相关

### Q6.1: 项目创建规则 ✅

**问题**:
- 项目名称是否有长度限制、格式要求？
- 是否允许创建同名项目？
- 用户可以创建的项目数量是否有限制？

**答案**:
1. **项目名称长度** - 项目名称可以很长，建议限制在255个字符以内（数据库字段限制），无特殊格式要求
2. **不允许同名** - 不允许创建同名项目，系统需要在创建时检查项目名称唯一性，如果重名则提示用户修改
3. **无数量限制** - 用户可以创建的项目数量没有限制

**影响范围**:
- FR-004（通过AI对话明确项目名称）
- 数据验证规则

---

### Q6.2: 宪章模板 ⏸️

**问题**:
- 有哪些预设的宪章模板可供选择？
- 用户是否可以完全自定义宪章（不选择任何模板）？
- 宪章模板的内容结构是什么？

**答案**:
**待后续补充** - 宪章模板目前还没有整理好，需要后续完善后再补充此部分内容

**临时方案**:
- 可以先提供一个默认的通用宪章模板作为起点
- 用户可以在此基础上修改

**影响范围**:
- FR-021（撰写宪章阶段）
- 模板管理设计

---

### Q6.3: 原型设计阶段 ✅

**问题**:
- 除了Trickle，是否支持其他原型工具（Figma、Axure等）？
- 原型URL是否需要验证有效性？
- 上传代码包的格式和大小限制是什么？

**答案**:
1. **仅支持Trickle** - 暂时只支持Trickle原型工具，不支持Figma、Axure等其他工具
2. **需要验证URL** - 系统需要验证Trickle URL的有效性，确保链接可访问
3. **不支持代码包上传** - 第一版不支持上传代码包功能，只支持Trickle URL输入

**影响范围**:
- FR-024（原型设计阶段）
- 文件上传和验证逻辑

---

## 七、技术架构相关

### Q7.1: 前端技术栈 ✅

**问题**:
- 三栏式界面是否响应式（支持不同屏幕尺寸）？
- 是否支持移动端访问？
- 对话框是否支持富文本（代码块、表格、图片等）？

**答案**:
1. **响应式设计** - 三栏式界面是响应式的，支持不同桌面屏幕尺寸，自适应窗口大小
2. **不支持移动端** - 第一版不支持移动端访问，只支持桌面浏览器
3. **支持富文本** - 对话框支持富文本显示，包括代码块、表格、图片等Markdown格式内容

**影响范围**:
- FR-009（三栏式界面布局）
- 技术选型和兼容性要求

---

### Q7.2: AI能力 ✅

**问题**:
- AI对话使用的是哪个模型（GPT、Claude、自研）？
- AI生成文档的质量如何保证？
- AI是否支持多轮对话的上下文记忆？

**答案**:
1. **预置模型** - 系统会预置一个AI模型（具体模型待技术选型确定）
2. **质量保证机制** - 通过两方面保证文档质量：
   - 模型选择：选择适合软件开发需求的高质量AI模型
   - 宪章提示：根据用户选择的宪章模板，生成对应的Prompt来引导AI，确保生成的文档符合宪章要求
3. **支持上下文记忆** - AI支持多轮对话的上下文记忆，能够理解整个对话历史并保持连贯性

**影响范围**:
- AI服务集成
- 成本和性能考虑

---

### Q7.3: 数据存储 ✅

**问题**:
- 文档的版本历史保留多少个版本？
- 项目数据的归档策略是什么（多久后归档、如何恢复）？
- 是否支持导出项目数据（JSON、PDF等）？

**答案**:
1. **版本历史** - 依赖飞书文档的版本管理能力，飞书支持多少个版本就保留多少个版本
2. **实时归档** - 项目数据实时归档到飞书，不需要等待一段时间后再归档
3. **支持导出** - 支持将项目数据导出成压缩包（包含所有文档和元数据）

**影响范围**:
- 数据库设计
- 数据治理策略

---

## 八、边界情况（来自spec.md）

这些是从spec.md中识别出的边界情况，需要明确处理策略：

### Q8.1: 用户关闭页面时的任务处理 ✅

**问题**: 当用户在文档生成过程中关闭页面，任务是否继续执行？系统应如何恢复状态？

**答案**:
1. **任务继续执行** - 用户关闭页面后，后台任务继续执行，不会中断
2. **状态恢复** - 用户重新进入项目时：
   - 恢复到最新的对话历史，显示所有对话记录
   - 显示当前项目的最新状态（当前阶段、已完成的文档等）
   - 如果任务已完成，显示完成结果；如果仍在执行，显示执行中状态

**影响范围**: FR-040（任务执行期间允许用户离开页面）

---

### Q8.2: 多用户同时编辑冲突 ✅

**问题**: 当多个用户同时编辑同一项目的文档时，如何处理冲突？

**答案**:
**第一版不支持多用户同时编辑** - 与Q4.2的答案一致：
- 不实现文档锁定机制
- 不显示"某某正在编辑"的提示
- 如果出现冲突（多人同时编辑），采用最后写入胜利策略（后提交的覆盖先提交的）
- 未来版本可考虑增加锁定机制和实时协作功能

**影响范围**: 并发控制设计（与Q4.2相关）

---

### Q8.3: 用户无目录权限时的项目创建 ✅

**问题**: 当用户没有任何虚拟组织/战略机会点/岗位族权限时，如何创建项目？

**答案**:
**目录暂时开放所有权限** - 第一版不实现目录权限控制：
- 所有用户可以看到所有目录（虚拟组织、战略机会点、岗位族）
- 所有用户可以在任意目录下创建项目
- 未来版本可根据需要增加目录权限控制

**影响范围**: FR-005（提供目录选择）

---

### Q8.4: 项目所有者离职处理 ✅

**问题**: 当项目所有者离职后，项目所有权如何转移？

**答案**:
**系统管理员处理** - 当项目所有者离职后：
- 系统管理员可以查看和管理所有项目
- 系统管理员可以将项目所有权转移给其他用户
- 系统管理员可以删除或归档无主项目
- 需要在系统中设置系统管理员角色（超级管理员）

**影响范围**: FR-045~046（权限管理）

---

### Q8.5: Trickle原型链接失效 ✅

**问题**: 当Trickle原型链接失效时，系统如何处理？

**答案**:
**使用时检查并提示** - 链接失效处理策略：
- 在用户使用项目（进入项目或查看原型）时，系统检查Trickle链接的有效性
- 如果链接失效（无法访问），显示警告提示："原型链接已失效，请更新链接"
- 提供"更新链接"按钮，允许用户重新输入有效的Trickle URL
- 链接失效不影响项目的其他功能使用

**影响范围**: FR-024（原型设计阶段）

---

### Q8.6: AI生成文档不符合预期 ✅

**问题**: 当AI生成的文档不符合用户预期时，用户如何快速回退到上一版本？

**答案**:
**暂不支持回退功能** - 第一版不实现文档版本回退：
- 用户只能通过重新编辑文档来修改不满意的内容
- 用户可以通过对话框告诉AI重新生成文档
- 可以依赖飞书文档的版本历史功能查看历史版本
- 未来版本可考虑在系统内实现快捷的版本回退功能

**影响范围**: 文档版本管理

---

### Q8.7: 阶段切换时的上下文一致性 ✅

**问题**: 当用户在不同阶段之间频繁切换时，如何保持上下文的一致性？

**答案**:
**依赖AI模型能力和文档上下文** - 上下文一致性策略：
- 依赖AI模型的上下文管理能力，保持对话历史的连贯性
- 系统将相关文档作为上下文提供给AI：
  - 当前阶段的文档（如正在编辑的spec.md）
  - 关联文档（如宪章、上一阶段的文档等）
  - 对话历史
- AI根据这些上下文理解当前项目的完整状态，保持一致性
- 用户切换阶段时，系统更新提供给AI的上下文文档

**影响范围**: FR-033（AI对话自动切换上下文）

---

### Q8.8: 飞书同步失败时的数据一致性 ✅

**问题**: 当飞书文档同步失败时，本地数据库和飞书的数据如何保持一致性？

**答案**:
**本地数据为准，重试补偿** - 同步失败处理策略（基于Q3.1的本地优先原则）：

1. **本地数据库为主** - 本地数据库是唯一真实数据源，飞书仅作为归档和展示
2. **自动重试机制** - 同步失败后自动重试3次，每次间隔递增（如1s、5s、15s）
3. **失败记录** - 如果重试仍失败，记录同步失败的文档和时间到失败队列
4. **后台补偿任务** - 定期（如每小时）扫描失败队列，重新尝试同步
5. **不阻塞用户** - 同步失败不影响用户继续使用系统，本地数据正常保存
6. **可选提示** - 可以在界面显示"飞书同步异常"的轻量提示，不打断用户操作
7. **手动触发** - 提供"立即同步"按钮，允许用户手动触发同步

**影响范围**: FR-028（文档同步到飞书），与Q3.1相关

---

## 📊 澄清进度统计

- **总问题数**: 26个
- **高优先级**: 5个（标记⚠️） - 全部已完成✅
- **已澄清**: 25个 ✅
- **待后续补充**: 1个（Q6.2 宪章模板）⏸️
- **澄清完成度**: 96% (25/26)

---

## 🎯 下一步行动

1. 用户逐个回答澄清问题
2. 将答案填入对应的"答案"字段
3. 澄清完成后，如需补充需求，在spec.md末尾追加，不修改原有内容
4. 更新澄清进度统计

---

## 📝 澄清原则

✅ **要做的**:
- 保持spec.md中原始用户故事不变
- 保持spec.md中已生成的需求和验收标准不变
- 在本文档记录所有疑问和答案
- 澄清后如需补充，在spec.md末尾追加新内容

❌ **不要做的**:
- 不要修改spec.md中的用户故事
- 不要修改spec.md中已有的FR-XXX需求
- 不要修改spec.md中已有的验收场景
- 不要在澄清过程中重写spec.md
